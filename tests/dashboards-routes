// prepare for testing and do the needed imports
const test = require('ava').default;
const listen = require('test-listen');
const got = require('got');
const http = require('node:http');
const app = require('../src/index');
const {jwtSign} = require('../src/utilities/authentication/helpers');
const { authenticate } = require('../src/utilities/validation/schemas');
const axios = require('axios');

// before running the tests, setup the test environment
test.before(async (t) => {
  t.context.server = http.createServer(app);
  t.context.prefixUrl = await listen(t.context.server);
  t.context.got = got.extend({ http2: true, throwHttpErrors: false, responseType: 'json', prefixUrl: t.context.prefixUrl })
});

// after the test, close all the pending matters
test.after((t) => {
  t.context.server.close();
});

// /*
//   Tests for dashboards routes
// */

// First create a dashboard
// test('POST | /create-dashboard', async (t) => {
//   const token = jwtSign({ username: "giachoud", id: "63c11a261429c8274c36cd79", email: 'giachoud@gapps.auth.gr' });
//   const dashboard_name = {name: "mydash4"}
//   const answer = await axios.post(`http://localhost:3000/dashboards/create-dashboard?token=${token}`, dashboard_name);
//   t.is(answer.status, 200);
//   console.log(answer.body)
// });

//Then find the created dashboard
test('GET | /dashboards', async (t) => {
  const token = jwtSign({ username: "giachoud", id: "63c11a261429c8274c36cd79", email: 'giachoud@gapps.auth.gr' });
  const { statusCode, body } = await t.context.got(`dashboards/dashboards?token=${token}`);
  t.is(statusCode, 200);
  console.log(body.dashboards);
});

// Finally delete the dashboard
// test('POST | /delete-dashboard', async (t) => {
//   const token = jwtSign({ username: "giachoud", id: "63c11a261429c8274c36cd79", email: 'giachoud@gapps.auth.gr' });
//   const dash_id = { id: "63d10d521ebb263904b07b0e" }
//   const answer = await axios.post(`http://localhost:3000/dashboards/delete-dashboard?token=${token}`, dash_id);
//   t.is(answer.status, 200);
// });

test('GET | /dashboard', async (t) => {
    const token = jwtSign({ username: "giachoud", id: "63c11a261429c8274c36cd79", email: 'giachoud@gapps.auth.gr' });
    const dash_id = { id: "63d10d521ebb263904b07b0e" };
    const { statusCode } = await axios.post(`dashboards/dashboard?token=${token}`, dash_id);
    t.is(statusCode, 200);
  });